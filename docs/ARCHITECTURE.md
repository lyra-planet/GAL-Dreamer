# GAL-Dreamer Pipeline 架构设计

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           GAL-Dreamer Pipeline                                  │
│                       (从用户创意到完整 Galgame 故事)                              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              用户输入                                              │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  user_idea: "一个现代校园恋爱故事，主角是高中生，遇到神秘转校生"            │  │
│  │  num_routes: 3                                                            │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              阶段1: 故事生成                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                   │
│  ┌─────────────┐    ┌───────────────┐    ┌─────────────┐    ┌──────────────┐    │
│  │   Agent 1   │───▶│   Agent 2     │───▶│   Agent 3   │───▶│   Agent 4    │    │
│  │StoryIntake  │    │ Worldbuilding │    │ CastDesign  │    │ MacroPlot    │    │
│  │ 故事理解     │    │  世界观构建    │    │  角色设计    │    │  大剧情结构   │    │
│  └─────────────┘    └───────────────┘    └─────────────┘    └──────────────┘    │
│         │                  │                  │                  │              │
│         ▼                  ▼                  ▼                  ▼              │
│  ┌─────────────┐    ┌───────────────┐    ┌─────────────┐    ┌──────────────┐    │
│  │StoryConstraints│  │  WorldSetting │    │CharacterProf│    │  MacroPlot   │    │
│  │题材/主题/基调 │    │时代/地点/规则  │    │主角/女主/配角│    │四幕/转折/高潮 │    │
│  └─────────────┘    └───────────────┘    └─────────────┘    └──────────────┘    │
│                                                                                   │
│  ┌─────────────┐    ┌───────────────┐                                          │
│  │   Agent 5   │───▶│   Agent 6     │                                          │
│  │RouteDesign  │    │ConflictEmotion │                                          │
│  │ 线路设计     │    │ 冲突与情绪     │                                          │
│  └─────────────┘    └───────────────┘                                          │
│         │                  │                                                      │
│         ▼                  ▼                                                      │
│  ┌─────────────┐    ┌───────────────┐                                          │
│  │ RouteDesign │    │ConflictDesign │                                          │
│  │分歧/结局     │    │冲突节点/情绪线 │                                          │
│  └─────────────┘    └───────────────┘                                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         阶段2: 一致性审查与全局统筹修复                           │
│                         (Consistency Check + Director Revision)                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                       一致性审查循环 (最多3轮)                             │   │
│  │                                                                         │   │
│  │   ┌───────────────┐                                                    │   │
│  │   │ConsistencyAgent│                                                   │   │
│  │   │  一致性检查    │                                                   │   │
│  │   └───────┬───────┘                                                    │   │
│  │           │                                                            │   │
│  │           ▼                                                            │   │
│  │    ┌─────────────────┐                                                 │   │
│  │    │ valid = true?   │                                                 │   │
│  │    └─────┬───────────┘                                                 │   │
│  │         │                                                            │   │
│  │    Yes  │  No                                                         │   │
│  │    ┌────┴────┐                                                          │   │
│  │    ▼         ▼                                                          │   │
│  │  通过   ┌─────────────┐                                                │   │
│  │         │详细问题列表   │                                                │   │
│  │         │detailed_issues│                                               │   │
│  │         └──────┬───────┘                                                │   │
│  │                │                                                         │   │
│  │                ▼                                                         │   │
│  │    ┌─────────────────────────────────────────────────────────┐        │   │
│  │    │              DirectorAgent 全局统筹                        │        │   │
│  │    │                                                         │        │   │
│  │    │  1. analyze_and_plan()                                 │        │   │
│  │    │     ├─ 从全局视角评估问题                                │        │   │
│  │    │     ├─ 分析问题根源和关联影响                             │        │   │
│  │    │     ├─ 制定最小化修改的修订计划                           │        │   │
│  │    │     └─ 确定执行顺序                                       │        │   │
│  │    │            ↓                                             │        │   │
│  │    │  2. execute_revision()                                  │        │   │
│  │    │     for agent in execution_order:                       │        │   │
│  │    │       ├─ 构建全局上下文 (其他Agent的相关内容)             │        │   │
│  │    │       ├─ 发送修改指令 + 全局上下文                        │        │   │
│  │    │       ├─ 4轮重试修复机制                                   │        │   │
│  │    │       └─ 验证修改结果                                      │        │   │
│  │    └─────────────────────────────────────────────────────────┘        │   │
│  │                │                                                         │   │
│  │                ▼                                                         │   │
│  │      ┌─────────────────────┐                                           │   │
│  │      │   更新故事快照        │                                           │   │
│  │      │   重新审查           │──┐                                         │   │
│  │      └─────────────────────┘  │                                         │   │
│  │                                │◀──── 最多3轮循环 ──────────┘         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              阶段3: 文本生成                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐                                                              │
│  │   Agent 8   │                                                              │
│  │   Narrator  │                                                              │
│  │  文本生成    │                                                              │
│  └──────┬──────┘                                                              │
│         │                                                                     │
│         ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                      生成各线路场景文本                                   │   │
│  │  - 每条线路的开场场景                                                    │   │
│  │  - 关键对话和旁白                                                        │   │
│  │  - 情感描写                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              最终输出                                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│  output/YYYYMMDD_HHMMSS/                                                    │
│  ├── galgame_story.json    (完整JSON数据)                                     │
│  └── story_summary.txt     (可读性摘要)                                       │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 数据流图

```
┌──────────────────┐
│   用户输入        │
│  user_idea       │
└────────┬─────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          StoryIntakeAgent                                     │
│  输入: user_idea                                                             │
│  输出: StoryConstraints { genre, themes, tone, must_have, forbidden }        │
└────────┬────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         WorldbuildingAgent                                     │
│  输入: story_constraints, genre, themes                                       │
│  输出: WorldSetting { era, location, type, rules, core_conflict_source }      │
└────────┬────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          CastDesignAgent                                        │
│  输入: world_setting, themes, required_routes                                  │
│  输出: CharacterProfile { protagonist, heroines[], side_characters[], ... }   │
└────────┬────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          MacroPlotAgent                                         │
│  输入: world_setting, cast_summary, themes                                     │
│  输出: MacroPlot { acts{}, major_twists[], story_arc, climax_point }          │
└────────┬────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          RouteDesignAgent                                        │
│  输入: macro_plot, heroine_list[]                                             │
│  输出: RouteDesign { routes[], common_route_length, branching_strategy }      │
└────────┬────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        ConflictEmotionAgent                                      │
│  输入: route_plots, character_states                                          │
│  输出: ConflictDesign { conflicts[], emotional_curves[] }                     │
└────────┬────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      一致性审查循环 (Consistency Loop)                           │
│                                                                                 │
│  StorySnapshot ──────▶ ConsistencyAgent ──────▶ detailed_issues[]            │
│       │                        │                                           │       │
│       │                        ▼                                           │       │
│       │                   valid == false?                                  │       │
│       │                        │                                           │       │
│       │                        ▼                                           │       │
│       │                   DirectorAgent                                   │       │
│       │                        │                                           │       │
│       │                ┌─────┴──────┐                                      │       │
│       │                ▼             ▼                                      │       │
│       │        analyze_and_plan  execute_revision                         │       │
│       │                │                  │                                 │       │
│       │                ▼                  ▼                                 │       │
│       │        GlobalRevisionPlan    各Agent修改                            │       │
│       │                │                  │                                 │       │
│       │                └──────────┬───────┘                                 │       │
│       │                           │                                        │       │
│       │                           ▼                                        │       │
│       │                    更新 StorySnapshot ─────────┘                       │       │
│       │                                                                     │       │
│       └──────────────▶ 重新检查 (最多3轮)                                   │       │
│                                                                                 │
└────────┬────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          NarratorAgent                                          │
│  输入: cast, routes, tone                                                     │
│  输出: Dict[scene_name, scene_text]                                            │
└────────┬────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            最终输出                                              │
│  {                                                                           │
│    "故事设定": { "题材", "主题", "基调" },                                    │
│    "世界观": { "时代", "地点", "核心冲突" },                                   │
│    "角色": { "主角", "可攻略角色" },                                          │
│    "故事结构": { "故事弧", "高潮" },                                          │
│    "线路": { "数量", "线路列表" },                                            │
│    "生成文本": { ... }                                                        │
│  }                                                                           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## DirectorAgent 详细设计

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           DirectorAgent                                         │
│                      (全局统筹 Agent)                                            │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                    ┌──────────────────────────────────┐
                    │        analyze_and_plan()        │
                    └──────────────────────────────────┘
                                       │
         ┌─────────────────────────────────────────────┼─────────────────────────┐
         │                                             │                     │
         ▼                                             ▼                     ▼
┌─────────────────┐                     ┌─────────────────┐   ┌─────────────────┐
│ StorySnapshot   │                     │ConsistencyIssue[]│   │  输出:          │
│ - story_intake  │                     │ - issue_type     │   │GlobalRevision   │
│ - worldbuilding │                     │ - severity       │   │Plan             │
│ - cast_design   │                     │ - description    │   │                 │
│ - macro_plot    │                     │ - source_agent   │   │ - has_issues    │
│ - route_design  │                     │ - fix_suggestion │   │ - revision_     │
│ - conflict_     │                     └─────────────────┘   │   strategy      │
│   emotion       │                                           │ - agent_         │
└─────────────────┘                                           │   modifications[]│
                                                              │ - execution_     │
                                                              │   order[]        │
                                                              └─────────────────┘
                                       │
                    ┌──────────────────────────────────┐
                    │       execute_revision()         │
                    └──────────────────────────────────┘
                                       │
         ┌─────────────────────────────────────────────┼─────────────────────────┐
         │                                             │                     │
         ▼                                             ▼                     ▼
┌─────────────────┐                     ┌─────────────────┐   ┌─────────────────┐
│GlobalRevision   │                     │   所有Agent      │   │  输出:          │
│Plan             │                     │ - worldbuilding  │   │更新后的         │
│ - has_issues    │                     │ - cast_design    │   │StorySnapshot    │
│ - agent_        │──────▶ 统筹修改 ───▶│ - macro_plot     │   │                 │
│   modifications[]│                   │ - route_design   │   │                 │
│ - execution_    │                     │ - conflict_      │   └─────────────────┘
│   order[]        │                     │   emotion        │
└─────────────────┘                     └─────────────────┘
```

## Agent 修改机制

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Agent 修改重试机制 (4轮)                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  第1轮: 生成全局修改指令                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ System: Agent的system_prompt                                              │   │
│  │ Human:  【全局修改指令】                                                  │   │
│  │           **修改目标**: 具体修改说明                                        │   │
│  │           **当前内容**: {完整的JSON}                                       │   │
│  │           **全局上下文**: 其他Agent的相关内容                               │   │
│  │           【重要提醒】                                                     │   │
│  │           1. 修改必须与整个故事保持一致                                     │   │
│  │           2. 考虑修改对其他部分的影响                                       │   │
│  │           3. 保持与已设定的世界观、角色性格的协调                            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                           │                                                   │       │
│                           ▼                                                   │       │
│                    ┌─────────────┐                                          │       │
│                    │   LLM 调用   │                                          │       │
│                    └──────┬──────┘                                          │       │
│                           │                                                   │       │
│                           ▼                                                   │       │
│                    ┌─────────────┐                                          │       │
│                    │ validate    │                                          │       │
│                    └──────┬──────┘                                          │       │
│                           │                                                   │       │
│              ┌────────────┴────────────┐                                     │       │
│              │                         │                                     │       │
│         通过  ▼                   失败  ▼                                     │       │
│      返回结果                 第2-4轮: 修复                              │       │
│                              ┌─────────────────────────────────────────┐   │       │
│                              │ System: Agent的system_prompt               │   │       │
│                              │ Human:  你之前的输出JSON缺少某些字段        │   │       │
│                              │         【之前的输出】{完整JSON}            │   │       │
│                              │         【错误信息】具体缺少哪些字段         │   │       │
│                              │         【重要要求】                     │   │       │
│                              │         1. 保持已有内容不变               │   │       │
│                              │         2. 只补充缺失字段                 │   │       │
│                              │         3. 不要截断任何已有字段           │   │       │
│                              └─────────────────────────────────────────┘   │       │
│                                                 │                               │       │
│                                                 └─── 最多4轮 ──────────────────┘       │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 关键设计决策

| 设计点 | 方案 | 理由 |
|--------|------|------|
| **一致性审查** | 只报告 critical/high 问题 | 避免过度审查导致无限循环 |
| **全局统筹** | DirectorAgent 统一协调 | 避免各Agent局部修改破坏整体一致性 |
| **修改机制** | 4轮重试 + 具体错误反馈 | 让LLM看到具体错误并针对性修复 |
| **执行顺序** | Director 确定顺序 | 确保先修改依赖源头，再修改依赖方 |
| **输出目录** | 时间戳子目录 | 避免覆盖之前的结果 |
